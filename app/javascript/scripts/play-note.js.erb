const WHITE_KEYS = ['q', 'w', 'e', 'r', 't', 'y', 'u','i', 'o', 'p', 'z', 'x', 'c', 'v', 'b']
const BLACK_KEYS = ['2', '3', '5', '6', '7','9', '0', 's', 'd', 'f']
<% helpers = ActionController::Base.helpers %>
const AUDIO_FILES = {
  "C3": "<%= helpers.audio_url 'audios/1-C3.m4a' %>",
  "Db3": "<%= helpers.audio_url 'audios/2-Db3.m4a' %>",
  "D3": "<%= helpers.audio_url 'audios/3-D3.m4a' %>",
  "Eb3": "<%= helpers.audio_url 'audios/4-Eb3.mp3' %>",
  "E3": "<%= helpers.audio_url 'audios/5-E3.m4a' %>",
  "F3": "<%= helpers.audio_url 'audios/6-F3.m4a' %>",
  "Gb3": "<%= helpers.audio_url 'audios/7-Gb3.m4a' %>",
  "G3": "<%= helpers.audio_url 'audios/8-G3.m4a' %>",
  "Ab3": "<%= helpers.audio_url 'audios/9-Ab3.mp3' %>",
  "A3": "<%= helpers.audio_url 'audios/10-A3.m4a' %>",
  "Bb3": "<%= helpers.audio_url 'audios/11-Bb3.m4a' %>",
  "B3": "<%= helpers.audio_url 'audios/12-B3.m4a' %>",

  "C4": "<%= helpers.audio_url 'audios/13-C4.m4a' %>",
  "Db4": "<%= helpers.audio_url 'audios/14-Db4.m4a' %>",
  "D4": "<%= helpers.audio_url 'audios/15-D4.m4a' %>",
  "Eb4": "<%= helpers.audio_url 'audios/16-Eb4.m4a' %>",
  "E4": "<%= helpers.audio_url 'audios/17-E4.m4a' %>",
  "F4": "<%= helpers.audio_url 'audios/18-F4.mp3' %>",
  "Gb4": "<%= helpers.audio_url 'audios/19-Gb4.m4a' %>",
  "G4": "<%= helpers.audio_url 'audios/20-G4.mp3' %>",
  "Ab4": "<%= helpers.audio_url 'audios/21-Ab4.m4a' %>",
  "A4": "<%= helpers.audio_url 'audios/22-A4.mp3' %>",
  "Bb4": "<%= helpers.audio_url 'audios/23-Bb4.m4a' %>",
  "B4": "<%= helpers.audio_url 'audios/24-B4.m4a' %>",
  "C5": "<%= helpers.audio_url 'audios/25-C5.m4a' %>"
}


// listens to the 'click' or 'keydown', then triggers the playNote function fot it, then dispatch chord if needed
 const playNotes = () => {
  // keys are all the 24 keys (selected class = 'key')
  const keys = document.querySelectorAll('.key')
  const whiteKeys = document.querySelectorAll('.key.white')
  const blackKeys = document.querySelectorAll('.key.black')
  // add event listener of type 'click' for each one fo the 24 keys
  // and then triggers the playNote function on that key
  if (keys.length) {
    keys.forEach(key => {
      key.addEventListener('click', ( ) => {
        playNote(key);
        dispatchChord(key.dataset.number);
      })
    })
  }
  // add event listener of type 'keydown' for each one fo the 24 keys
  // and then triggers the playNote function on that key
  if(whiteKeys.length && blackKeys.length) {
    document.addEventListener('keydown', (e) => {
      if (e.repeat) return
      const key = e.key
      const whiteKeyIndex = WHITE_KEYS.indexOf(key)
      const blackKeyIndex = BLACK_KEYS.indexOf(key);
      if (whiteKeyIndex > -1) {
        playNote(whiteKeys[whiteKeyIndex]);
        dispatchChord(whiteKeys[whiteKeyIndex].dataset.number);
      };
      if (blackKeyIndex > -1) {
        playNote(blackKeys[blackKeyIndex]);
        dispatchChord(blackKeys[blackKeyIndex].dataset.number);
      };
    })
  }

};

// play the selected key(s)
const playNote = (key) => {
  // console.log(`${key.dataset.number}-${key.dataset.note}.m4a`)
  // console.log("key.dataset", key.dataset);
  // prints something like: 'this key is pressed: C3'
  // console.log('this key is pressed:', key.dataset.note);

  // const noteAudio = document.getElementById(key.dataset.note);

  // prints something like: <audio id="C3" src="http://localhost:3000/assets/audios/1-C3-35aa070â€¦.m4a" type="audio/mpeg"></audio>
  // console.log("noteAudio:", noteAudio);
  // current Time = 0 sets the 'restart' to the beginnning (t = 0s) of the file
  // so if I press a key repeatedly very fast, I don't have to wait until the end of the file, but now starts again from beginning, like a normal piano
  const file = AUDIO_FILES[key.dataset.note]
  // console.log({file})
  const noteAudio = document.createElement('audio')
  noteAudio.src = file
  // console.log('audio src', noteAudio.src)
  noteAudio.type = "audio/mpeg"
  noteAudio.currentTime = 0
  noteAudio.play();
  key.classList.add('active');
  const audios = document.querySelectorAll('audio')
  noteAudio.onended = () => {
        // noteAudio.currentSrc = null;
        noteAudio.src = "";
        noteAudio.srcObject = null;
        noteAudio.remove();
    };
  // The setTimeout() method calls a function or evaluates an expression after a specified number of milliseconds.
  // so we are removing the highlighting after 300ms = 0.3s, otherwise it never gets removed
  setTimeout(() => { key.classList.remove('active') }, 300);
}

const dispatchChord = (number) => {
  console.log(window.location.pathname)
  let path = window.location.pathname;
  // e,g, number is 1 if C3, but this number is a string!
  const root = Number.parseInt(number);
  switch(path){
    //chords below
    case '/major_triad': playChord(majorTriad(root)); break;
    case '/minor_triad': playChord(minorTriad(root)); break;
    case '/diminished_triad': playChord(diminishedTriad(root)); break;
    case '/augmented_triad': playChord(augmentedTriad(root)); break;
    case '/tritone': playChord(tritone(root)); break;
  }
}

const playChord = (array) => {
  array.forEach(number => {
    // this number is in the data-number attribute of div "key"
    const key = document.querySelector(`[data-number="${number}"]`);
    playNote(key);
  })
}

const majorTriad = (root) =>  [root, root+4, root+7];
const minorTriad = (root) =>  [root, root+3, root+7];
const diminishedTriad = (root) =>  [root, root+4, root+6];
const augmentedTriad = (root) => [root, root+4, root+8];
const tritone = (root) => [root, root+6];



export { playNotes }

const firstInversion = (chord) => {
  return [];
}


// const fetchMajorTriad = (number) => {
//   console.log(number)
//   // goes to  harmonies#construct_major_chord using this fetch method
//   const url = '/harmonies/construct_major_triad'
//   // my params[:number] gets triggered
//   fetch(`${url}?number=${number}`)
//     .then(response => response.json())
//     .then((data) => {
//       // data is the json represtaation of @results (the array I returned by controller)
//       console.log("data: ",data);

//         data.forEach(note => {
//           const audio = document.getElementById(note.name)
//           audio.currentTime = 0
//           audio.play()
//           const key = document.querySelector(`[data-number="${note.number}"]`)
//           key.classList.add('active')
//           setTimeout(() => { key.classList.remove('active'); }, 300)
//         });

//     })
// }


